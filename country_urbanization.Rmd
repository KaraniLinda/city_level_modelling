---
title: "country_urbanization"
output: html_document
date: "2023-04-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Load libraries

library(tidyverse)
library(here)
library(viridis)
library(sf)
library(ggpp)
library(raster)
library(rasterVis)
library(readxl)
library(xml2)
library("RColorBrewer")
library(foreign)
library(haven)
library(Hmisc)
library(fuzzyjoin)
```


```{r}
## Read kenya population density data

path <- "G:\\Shared drives\\DATA_WDL\\Mpro_2.0\\01_Data\\R_2022_12_29\\2023_01_23_2017ppp\\01_inputs\\population\\World pop\\Kenya"

ken <-  raster(paste0(path, "\\ken_pd_2020_1km_UNadj.tif"))

##Read Kenya consumption survey data

ken_cons <- read_dta("ken_consumption\\Consumption_aggregate.dta")

## Read shape file


shape_kenya <- read_sf(here::here("ken_shape/gadm41_KEN_1.shp"))


```

## Aggregate consumption kenya

```{r}
unique(ken_cons$county)
```


```{r}

#Convert column county and resid to factor columns
ken_cons$county <- as_factor(ken_cons$county)
ken_cons$resid <- as_factor(ken_cons$resid)
ken_cons$eatype <- as_factor(ken_cons$eatype)
```



```{r}
#Get the total consumption

ken_cons <- ken_cons %>%
    mutate(tot_cons = rowSums(dplyr::select(., padqnfitems:padqfdcons)))


```

```{r}
# Add quantiles from national distribution

# Select relevant variables from survey data

ken_var <- ken_cons %>% 
    dplyr::select(county, resid,weight_pop,tot_cons)

# Compute quantiles

ken_qnt <- wtd.quantile(ken_var$tot_cons, weights = ken_var$weight_pop, probs = seq(0, 1, 0.1))

# create data frame with quantiles and corresponding cons values
ken_qnt <- data.frame(cbind(names(ken_qnt), ken_qnt))
names(ken_qnt) <- c("quantile", "value")
ken_qnt$value <- as.numeric(ken_qnt$value)



# match data with quantiles
ken_var$quantile <- ken_qnt$quantile[findInterval(ken_var$tot_cons, ken_qnt$value, all.inside = TRUE)+1]

ken_var %>% 
    View()
```


```{r}
# compute shares of groups per quantile
ken_var2 <- ken_var %>%
  group_by(resid) %>%
  mutate(wgt_qtl = sum(weight_pop)) %>% 
  group_by(quantile, resid) %>%
  summarise(share = sum(weight_pop)/wgt_qtl) %>%
  distinct()


ken_var2 %>% 
    pivot_wider(names_from = resid, values_from = share) %>% 
    write_csv("quantiles1.csv")

```
```{r}

# calculate the weighted mean spending for each county
county_wtd_mean <- ken_var %>%
  group_by(county) %>%
  summarise(avg_spend_per_person = wtd.mean(tot_cons, weights = weight_pop))


# calculate the average spend per person for all rural and all urban

resid_wtd_mean <- ken_var %>%
  group_by(resid) %>%
  summarise(avg_spend = wtd.mean(tot_cons, weights = weight_pop))

```
```{r}
# Multiply county urbanization rates by average spend per person in each rural and urban area

county_avg_spending <- shape_kenya %>%
   mutate(avg_spend = (urbanization2/100 * 18450.799) + (rural/100 * 9094.087)) %>% 
   rename(county = NAME_1)

```




```{r}

# clean up the county names by removing non-alphanumeric characters
county_avg_spending$county <- gsub("[^[:alnum:]]", "", county_avg_spending$county)
county_wtd_mean$county <- gsub("[^[:alnum:]]", "", county_wtd_mean$county)

#Merge the two data frames for plotting

# Join by county names

shape_kenya2 <- regex_left_join(county_avg_spending , county_wtd_mean, by = "county", ignore_case = TRUE)

```


## World bank urbanization classification
```{r}
# Extract population values

library(exactextractr)

shape_kenya$pop_2020 <- exact_extract(ken, shape_kenya, "sum")

```



```{r}
# Convert county area to square kilometers
shape_kenya$area_km2 <- st_area(shape_kenya) / 1e+06
```


```{r}
# Calculate population density for each county in square kilometers
shape_kenya$pop_density_km2 <- shape_kenya$pop_2020 / shape_kenya$area_km2
```

```{r}
# Remove [1/m^2] from pop_density_km2
shape_kenya$pop_density_km2 <- gsub("\\s*\\[1/m\\^2\\]", "", shape_kenya$pop_density_km2)
shape_kenya$pop_density_km2 <- as.numeric(shape_kenya$pop_density_km2)
```




```{r}
# Create new column for city/town/rural classification
#shape_kenya$urbanization <- ifelse(shape_kenya$pop_2020 > 50000 & shape_kenya$pop_density_km2 > 1500, "City", 
                                      #ifelse(shape_kenya$pop_2020 > 5000 & #shape_kenya$pop_density_km2 > 250, "Town", "Rural"))

```



```{r}

#calculate the urbanization rate for each county

shape_kenya$urbanization <- ifelse(shape_kenya$pop_density_km2 > 1500 & shape_kenya$pop_2020 >= 50000,(0.6 * (shape_kenya$pop_density_km2 / max_density) + 0.4 * (shape_kenya$pop_2020 / max_pop)) * 100,
                            ifelse(shape_kenya$pop_density_km2 > 250 & shape_kenya$pop_2020 >= 5000,
                                            (0.2 * (shape_kenya$pop_density_km2 / max_density) + 0.8 * (shape_kenya$pop_2020 / max_pop)) * 100,
                            ifelse(shape_kenya$pop_density_km2 > 0 & shape_kenya$pop_density_km2 <= 250 & shape_kenya$pop_2020 > 0 & shape_kenya$pop_2020 < 5000, (0.1 * (shape_kenya$pop_density_km2 / max_density) + 0.9 * (shape_kenya$pop_2020 / max_pop)) * 100, (shape_kenya$pop_density_km2 / max_density) * 7 + (shape_kenya$pop_2020 / max_pop) * 3
                                        )
                                    )
                                )

```


```{r}
##Same weights appeoach

# Set the maximum population and population density in the data frame
max_pop <- max(shape_kenya$pop_2020)
max_density <- max(shape_kenya$pop_density_km2)


# Use ifelse statements to calculate the urbanization rate for each county
shape_kenya$urbanization <- ifelse(shape_kenya$pop_density_km2 > 1500 & shape_kenya$pop_2020 >= 50000,
                                    (0.5 * (shape_kenya$pop_density_km2 / max_density + shape_kenya$pop_2020 / max_pop)) * 100,
                                      
                                    ifelse(shape_kenya$pop_density_km2 > 250 & shape_kenya$pop_2020 >= 5000,
                                            (0.5 * (shape_kenya$pop_density_km2 / max_density + shape_kenya$pop_2020 / max_pop)) * 100,
                                        
                                        ifelse(shape_kenya$pop_density_km2 > 0 & shape_kenya$pop_density_km2 <= 250 & shape_kenya$pop_2020 > 0 & shape_kenya$pop_2020 < 5000,
                                                (0.5 * (shape_kenya$pop_density_km2 / max_density + shape_kenya$pop_2020 / max_pop)) * 100,
                                            
                                                (0.7 * (shape_kenya$pop_density_km2 / max_density) + 0.3 * (shape_kenya$pop_2020 / max_pop)) * 100
                                        )
                                    )
                                )

```


```{r}
# Calculate the urbanization rate for each county
#shape_kenya$urbanization3 <- ((0.5 * (log10(shape_kenya$pop_density_km2) / log10(max_density))) + (0.5 * (log10(shape_kenya$pop_2020) / log10(max_pop))))


#shape_kenya$urbanization3 <- shape_kenya$urbanization3 * 100
```


```{r}
# Calculate the urbanization rate for each county
shape_kenya$urbanization2 <- ((0.5 * (log10(shape_kenya$pop_density_km2) / log10(max_density))) + (0.5 * (log10(shape_kenya$pop_2020) / log10(max_pop))))

# Rescale the urbanization values from 0 to 100%
min_urbanization <- min(shape_kenya$urbanization2, na.rm = TRUE)
max_urbanization <- max(shape_kenya$urbanization2, na.rm = TRUE)
shape_kenya$urbanization2 <- ((shape_kenya$urbanization2 - min_urbanization) / (max_urbanization - min_urbanization)) * 100

# Set the urbanization rate of the most rural county to 0%
shape_kenya$urbanization2[which.min(shape_kenya$urbanization2)] <- 0


```

```{r}
#Calculate percentage rural(1-%urban)

shape_kenya$rural <- 100 - shape_kenya$urbanization2

shape_kenya %>% 
    st_write("urbanization.csv")

```

```{r}
# convert quantile dataframe to long format and multiply by %urban/rural to get national distribution


```





```{r}
# Set plot size and margins
par(mar = c(4, 4, 2, 2), mgp = c(2, 0.7, 0))



# Plot the data
plot(log10(shape_kenya$pop_2020), log10(shape_kenya$pop_density_km2), 
     xlab = "Population (log scale)", ylab = "Population density (log scale)",
     pch = 20, cex = 0.8, col = ifelse(shape_kenya$urbanization2 >= 50, "red", "blue"),
     main = "Urbanization Rates by County in Kenya")

# Add county names as text labels
text(log10(shape_kenya$pop_2020), log10(shape_kenya$pop_density_km2), 
     labels = shape_kenya$NAME_1, cex = 0.6, pos = 4)

# Add a diagonal dashed line to separate blue and red points
abline(a = 0, b = 1, lty = 2)

# Add a legend
legend("topleft", legend = c("Urbanization rate >= 50%", "Urbanization rate < 50%"),
       col = c("red", "blue"), pch = 20, cex = 0.8, bty = "n")




```

```{r}
# Average spend - county vs urbanization method

ggplot(shape_kenya2, aes(x = avg_spend, y = avg_spend_per_person)) +
  geom_point(size = 3) +
  scale_x_log10(name = "Average Spending (Urbanization)") +
  scale_y_log10(name = "Average Spending (County)") +
  theme_classic() +
  geom_text(aes(label = county.y), hjust = 1.2, vjust = 0.5, size = 3)+
  labs(title = "Comparison of Average Spending from County and Urbanization Approaches") 
```

