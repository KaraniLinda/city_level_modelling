---
title: "country_urbanization"
output: html_document
date: "2023-04-12"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Load libraries

library(tidyverse)
library(here)
library(viridis)
library(sf)
library(tmap)
library(ggpp)
library(raster)
library(rasterVis)
library(readxl)
library(xml2)
library("RColorBrewer")
library(foreign)
library(haven)
library(Hmisc)
library(fuzzyjoin)
```


```{r}
## Read kenya population density data

path <- "G://Shared drives//DATA_WDL//Mpro_2.0//01_Data//R_2022_12_29//2023_01_23_2017ppp//01_inputs//population//World pop//Kenya"

ken <-  raster(paste0(path, "\\ken_pd_2020_1km_UNadj.tif"))

##Read Kenya consumption survey data

ken_cons <- read_dta("ken_consumption//Consumption_aggregate.dta")


## Read shape file


shape_kenya <- read_sf(here::here("ken_shape/gadm41_KEN_1.shp"))


```

## Aggregate consumption kenya


```{r}

#Convert column county and resid to factor columns
ken_cons$county <- as_factor(ken_cons$county)
ken_cons$resid <- as_factor(ken_cons$resid)
ken_cons$eatype <- as_factor(ken_cons$eatype)
```



```{r}
#Get the total consumption

ken_cons <- ken_cons %>%
    rename(tot_cons = padqexp)


```




```{r}


# Select relevant variables from survey data

ken_var <- ken_cons %>% 
    dplyr::select(county, resid,weight_pop,tot_cons)

# Compute quantiles

ken_qnt <- wtd.quantile(ken_var$tot_cons, weights = ken_var$weight_pop, probs = seq(0, 1, 0.1))

# create data frame with quantiles and corresponding cons values
ken_qnt <- data.frame(cbind(names(ken_qnt), ken_qnt))
names(ken_qnt) <- c("quantile", "value")
ken_qnt$value <- as.numeric(ken_qnt$value)



# match data with quantiles
ken_var$quantile <- ken_qnt$quantile[findInterval(ken_var$tot_cons, ken_qnt$value, all.inside = TRUE)+1]

ken_var %>% 
    View()
```


```{r}
# compute shares of groups per quantile
ken_var2 <- ken_var %>%
  group_by(resid) %>%
  mutate(wgt_qtl = sum(weight_pop)) %>% 
  group_by(quantile, resid) %>%
  summarise(share = sum(weight_pop)/wgt_qtl) %>%
  distinct()


ken_var2 %>% 
    pivot_wider(names_from = resid, values_from = share) %>% 
    write_csv("quantiles1.csv")

```
```{r}

# calculate the weighted mean spending for each county
county_wtd_mean <- ken_var %>%
  group_by(county) %>%
  summarise(avg_spend_per_person = wtd.mean(tot_cons, weights = weight_pop))


# calculate the average spend per person for all rural and all urban

resid_wtd_mean <- ken_var %>%
  group_by(resid) %>%
  summarise(avg_spend = wtd.mean(tot_cons, weights = weight_pop))

```
```{r}
# Multiply county urbanization rates by average spend per person in each rural and urban area

county_avg_spending <- shape_kenya %>%
   mutate(avg_spend = (urbanization2/100 * 18450.799) + (rural/100 * 9094.087)) %>% 
   rename(county = NAME_1)

```




```{r}

# clean up the county names by removing non-alphanumeric characters
county_avg_spending$county <- gsub("[^[:alnum:]]", "", county_avg_spending$county)
county_wtd_mean$county <- gsub("[^[:alnum:]]", "", county_wtd_mean$county)

#Merge the two data frames for plotting

# Join by county names

shape_kenya2 <- regex_left_join(county_avg_spending , county_wtd_mean, by = "county", ignore_case = TRUE)

```


## World bank urbanization classification
```{r}
# Extract population values

library(exactextractr)

shape_kenya$pop_2020 <- exact_extract(ken, shape_kenya, "sum")

```



```{r}
# Convert county area to square kilometers
shape_kenya$area_km2 <- st_area(shape_kenya) / 1e+06
```


```{r}
# Calculate population density for each county in square kilometers
shape_kenya$pop_density_km2 <- shape_kenya$pop_2020 / shape_kenya$area_km2
```

```{r}
# Remove [1/m^2] from pop_density_km2
shape_kenya$pop_density_km2 <- gsub("\\s*\\[1/m\\^2\\]", "", shape_kenya$pop_density_km2)
shape_kenya$pop_density_km2 <- as.numeric(shape_kenya$pop_density_km2)
```




```{r}
# Create new column for city/town/rural classification
#shape_kenya$urbanization <- ifelse(shape_kenya$pop_2020 > 50000 & shape_kenya$pop_density_km2 > 1500, "City", 
                                      #ifelse(shape_kenya$pop_2020 > 5000 & #shape_kenya$pop_density_km2 > 250, "Town", "Rural"))

```



```{r}

#calculate the urbanization rate for each county

shape_kenya$urbanization <- ifelse(shape_kenya$pop_density_km2 > 1500 & shape_kenya$pop_2020 >= 50000,(0.6 * (shape_kenya$pop_density_km2 / max_density) + 0.4 * (shape_kenya$pop_2020 / max_pop)) * 100,
                            ifelse(shape_kenya$pop_density_km2 > 250 & shape_kenya$pop_2020 >= 5000,
                                            (0.2 * (shape_kenya$pop_density_km2 / max_density) + 0.8 * (shape_kenya$pop_2020 / max_pop)) * 100,
                            ifelse(shape_kenya$pop_density_km2 > 0 & shape_kenya$pop_density_km2 <= 250 & shape_kenya$pop_2020 > 0 & shape_kenya$pop_2020 < 5000, (0.1 * (shape_kenya$pop_density_km2 / max_density) + 0.9 * (shape_kenya$pop_2020 / max_pop)) * 100, (shape_kenya$pop_density_km2 / max_density) * 7 + (shape_kenya$pop_2020 / max_pop) * 3
                                        )
                                    )
                                )

```


```{r}
##Same weights appeoach

# Set the maximum population and population density in the data frame
max_pop <- max(shape_kenya$pop_2020)
max_density <- max(shape_kenya$pop_density_km2)


# Use ifelse statements to calculate the urbanization rate for each county
shape_kenya$urbanization <- ifelse(shape_kenya$pop_density_km2 > 1500 & shape_kenya$pop_2020 >= 50000,
                                    (0.5 * (shape_kenya$pop_density_km2 / max_density + shape_kenya$pop_2020 / max_pop)) * 100,
                                      
                                    ifelse(shape_kenya$pop_density_km2 > 250 & shape_kenya$pop_2020 >= 5000,
                                            (0.5 * (shape_kenya$pop_density_km2 / max_density + shape_kenya$pop_2020 / max_pop)) * 100,
                                        
                                        ifelse(shape_kenya$pop_density_km2 > 0 & shape_kenya$pop_density_km2 <= 250 & shape_kenya$pop_2020 > 0 & shape_kenya$pop_2020 < 5000,
                                                (0.5 * (shape_kenya$pop_density_km2 / max_density + shape_kenya$pop_2020 / max_pop)) * 100,
                                            
                                                (0.7 * (shape_kenya$pop_density_km2 / max_density) + 0.3 * (shape_kenya$pop_2020 / max_pop)) * 100
                                        )
                                    )
                                )

```


```{r}
# Calculate the urbanization rate for each county
#shape_kenya$urbanization3 <- ((0.5 * (log10(shape_kenya$pop_density_km2) / log10(max_density))) + (0.5 * (log10(shape_kenya$pop_2020) / log10(max_pop))))


#shape_kenya$urbanization3 <- shape_kenya$urbanization3 * 100
```


```{r}
# Calculate the urbanization rate for each county
shape_kenya$urbanization2 <- ((0.5 * (log10(shape_kenya$pop_density_km2) / log10(max_density))) + (0.5 * (log10(shape_kenya$pop_2020) / log10(max_pop))))

# Rescale the urbanization values from 0 to 100%
min_urbanization <- min(shape_kenya$urbanization2, na.rm = TRUE)
max_urbanization <- max(shape_kenya$urbanization2, na.rm = TRUE)
shape_kenya$urbanization2 <- ((shape_kenya$urbanization2 - min_urbanization) / (max_urbanization - min_urbanization)) * 100

# Set the urbanization rate of the most rural county to 0%
shape_kenya$urbanization2[which.min(shape_kenya$urbanization2)] <- 0


```

```{r}
#Calculate percentage rural(1-%urban)

shape_kenya$rural <- 100 - shape_kenya$urbanization2

shape_kenya %>% 
    st_write("urbanization.csv")

```

```{r}

shape_kenya2$avg_error <- sqrt(((shape_kenya2$avg_spend - shape_kenya2$avg_spend_per_person)^2)/2)



```





```{r}
# Set plot size and margins
par(mar = c(4, 4, 2, 2), mgp = c(2, 0.7, 0))



# Plot the data
plot(log10(shape_kenya$pop_2020), log10(shape_kenya$pop_density_km2), 
     xlab = "Population (log scale)", ylab = "Population density (log scale)",
     pch = 20, cex = 0.8, col = ifelse(shape_kenya$urbanization2 >= 50, "red", "blue"),
     main = "Urbanization Rates by County in Kenya")

# Add county names as text labels
text(log10(shape_kenya$pop_2020), log10(shape_kenya$pop_density_km2), 
     labels = shape_kenya$NAME_1, cex = 0.6, pos = 4)

# Add a diagonal dashed line to separate blue and red points
abline(a = 0, b = 1, lty = 2)

# Add a legend
legend("topleft", legend = c("Urbanization rate >= 50%", "Urbanization rate < 50%"),
       col = c("red", "blue"), pch = 20, cex = 0.8, bty = "n")




```

```{r}
# Average spend - county vs urbanization method

ggplot(shape_kenya2, aes(x = avg_spend, y = avg_spend_per_person)) +
  geom_point(size = 3) +
  scale_x_log10(name = "Average Spending (Urbanization)") +
  scale_y_log10(name = "Average Spending (County)") +
  theme_classic() +
  geom_text(aes(label = county.y), hjust = 1.2, vjust = 0.5, size = 3)+
  labs(title = "Comparison of Average Spending from County and Urbanization Approaches") 
```


```{r}
ggplot(shape_kenya2, aes(x = avg_spend, y = avg_spend_per_person)) +
  geom_point(size = 3) +
  scale_x_log10(name = "Average Spending (Urbanization)") +
  scale_y_log10(name = "Average Spending (County)") +
  theme_classic() +
  geom_text(aes(label = county.y), hjust = 1.2, vjust = 0.5, size = 3) +
  labs(title = "Comparison of Average Spending from County and Urbanization Approaches") +
  geom_errorbar(aes(x = avg_spend, y = avg_spend_per_person,
                    ymin = avg_spend_per_person - shape_kenya2$avg_error,
                    ymax = avg_spend_per_person + shape_kenya2$avg_error), width = 0)


```

## Greater Nairobi plotting

```{r}
## Read shape file


shape3 <- read_sf(here::here("ken_shape/gadm41_KEN_3.shp"))
shape1 <- read_sf(here::here("ken_shape/gadm41_KEN_1.shp"))


```



```{r}
# Filter the ADM2 boundary data to only show Nairobi and its surroundings
nairobi_adm2 <- shape1[shape1$NAME_1 == "Nairobi" |
                            shape1$NAME_1 == "Kiambu" |
                            shape1$NAME_1 == "Kajiado" |
                            shape1$NAME_1 == "Machakos",]


# Filter the ADM3 boundary data to only show Nairobi and its surroundings
nairobi_adm3 <- shape3[shape3$NAME_3 == "Kitengela" |
                            shape3$NAME_3 == "Ngong" |
                            shape3$NAME_3 == "Ongata Rongai" |
                            shape3$NAME_3 == "Githunguri" |
                            shape3$NAME_3 == "Juja" |
                            shape3$NAME_3 == "Murera" |
                            shape3$NAME_3 == "Theta" |
                            shape3$NAME_3 == "Witeithie" |
                            shape3$NAME_3 == "Kalimoni" |
                            shape3$NAME_3 == "Ndumberi" |
                            shape3$NAME_3 == "Riabai" |
                            shape3$NAME_3 == "Ting'Ang'A"|
                            shape3$NAME_3 == "Karai"|
                            shape3$NAME_3 == "Kikuyu"|
                            shape3$NAME_3 == "Kinoo"|
                            shape3$NAME_3 == "Nachu"|
                            shape3$NAME_3 == "Sigona"|
                            shape3$NAME_3 == "Bibirioni" |
                            shape3$NAME_3 == "Limuru Central" |
                            shape3$NAME_3 == "Limuru East" |
                            shape3$NAME_3 == "Ndeiya"|
                            shape3$NAME_3 == "Ngecha Tigoni"|
                            shape3$NAME_3 == "Biashara"|
                            shape3$NAME_3 == "Gitothua"|
                            shape3$NAME_3 == "Kiuu"|
                            shape3$NAME_3 == "Gatuanyaga"|
                            shape3$NAME_3 == "Hospital"|
                            shape3$NAME_3 == "Kamenu"|
                            shape3$NAME_3 == "Ngoliba"|
                            shape3$NAME_3 == "Kalama"|
                            shape3$NAME_3 == "Kola"|
                            shape3$NAME_3 == "Machakos Central"|
                            shape3$NAME_3 == "Mua"|
                            shape3$NAME_3 == "Mumbuni North"|
                            shape3$NAME_3 == "Mutituni"|
                            shape3$NAME_3 == "Muvuti/Kiima-Kimwe"|
                            shape3$NAME_3 == "Township",]
```


```{r}
# Plot the ADM2 boundary for Nairobi and its surroundings

tm_shape(nairobi_adm2) +
  tm_polygons() +
  tm_text("NAME_1", size = 0.5, col = "black") +
  tm_shape(nairobi_adm3) +
  tm_polygons(col = "red", alpha = 0.4) +
  tm_layout(legend.position = c("left", "bottom"), legend.bg.color = "white") +
  tm_basemap(server = "OpenStreetMap") 
```



```{r}
library(leaflet)


# Set the center and zoom level for the map view
center <- c(-1.28, 36.82)
zoom <- 10

# Create a custom marker icon
icon <- makeIcon(
  iconUrl = "https://leafletjs.com/examples/custom-icons/leaf-green.png",
  iconWidth = 38, iconHeight = 95,
  iconAnchorX = 22, iconAnchorY = 94,
  popupAnchorX = -3, popupAnchorY = -76
)

# Create a leaflet map with the Kenya ADM1 boundary and the Nairobi ADM2 and ADM3 boundaries
leaflet() %>%
  addProviderTiles("OpenStreetMap.Mapnik") %>%
  addPolygons(data = shape1, fillOpacity = 0, color = "black", weight = 2) %>%
  addPolygons(data = nairobi_adm2, fillOpacity = 0.5, color = "blue") %>%
  addPolygons(data = nairobi_adm3, fillOpacity = 0.2, color = "red") %>%
  addMarkers(lng = center[2], lat = center[1], icon = icon) %>%
  setView(lng = center[2], lat = center[1], zoom = zoom)



```


# All city spending

```{r}

cities <- "/Users/lindakarani/Library/CloudStorage/GoogleDrive-linda.karani@worlddata.io/Shared drives/DATA_WDL/wdp_city_spending/wdpro_combination"

WDPro <- "/Users/lindakarani/Library/CloudStorage/GoogleDrive-linda.karani@worlddata.io/Shared drives/DATA_WDL/Mpro_2.0/01_Data/R_2022_12_29/2023_03_13_2017ppp/03_outputs"

## Read in Matts output city spending file
all_city <- read_rds(paste0(cities,"/city_distribution.rds"))

## City spending file including residual for all countries
resid_cit <- read_rds(paste0(cities,"/residual_city_distribution.rds"))

##World data pro
worlddatapro <- read_rds(paste0(WDPro, "/05_003_merge_mpro2_ages_R_2022_12_29_2017ppp_1_USD.rds"))
```



```{r}

## Get the spending distribution for Kenya, south Africa and Nigeria 
city <- all_city %>%
    filter(ccode %in% c("NGA","ZAF", "KEN")) %>% 
    dplyr::select("year","ccode","pop","spending_data_kernel", "name")


#unnest the list column

city_df <- city %>%
  unnest(cols =  spending_data_kernel)

city_df %>% 
    View()

city_df %>% 
    write_csv("city_spending_rev_2.csv")


```


```{r}

## Get consumer class breakdown for Kenya, South Africa and Nigeria(top cities)- slides 10 -15
result <- city_df %>%
  filter(year %in% c(2022, 2030)) %>%
  group_by(ccode, name, year) %>%
  mutate(spending_threshold_group = ifelse(spending_threshold >= 120, "over 120",
                                       ifelse(spending_threshold >= 80, "over 80",
                                           ifelse(spending_threshold >= 40, "over 40",
                                                  ifelse(spending_threshold >= 12, "over 12", "below 12"))))) %>% 
    group_by(ccode, name, year, spending_threshold_group) %>% 
    summarise(headcount_sum = sum(headcount))
 

##Check totals for each country for all consumer classes

tots <- result %>% 
    group_by(ccode,year) %>% 
    summarise(tot = sum(headcount_sum))
    
    
    
```


```{r}
## Get the totals for the three countries without including upper bounds i.e over 12, over 40 and over 80 (slides 8 and 9)- Nightlights data
resultsum <- result %>% 
  group_by(ccode, year) %>%
  summarise(below12 = sum(headcount_sum[spending_threshold_group %in% c("below 12")]),
            over12 = sum(headcount_sum[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(headcount_sum[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(headcount_sum[spending_threshold_group %in% c("over 80", "over 120")]))
```


## Plot bar plots to compare old vs new method($12+ consumer class) i.e loreal, nightlights and rescaled numbers


```{r}

## Output file with breakdown of cities for $12+ consumer class
library(readxl)
ken_nig_sa <- read_xlsx("cities12USD.xlsx")

```



```{r}

## filter for Nigeria only
df_nig <- ken_nig_sa %>% 
    filter(Country == "Nigeria")


# Reshape the data frame to have one value column
df_reshaped_nig <- df_nig %>% 
  pivot_longer(cols = c(loreal,nightlights,`nightlights rescaled`), names_to = "Method", values_to = "Value")

# Create bar plot
plot <- ggplot(df_reshaped_nig, aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "Comparison of loreal vs nightlights approach for $12+ consumer class in Nigeria") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size = 10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))


```
```{r}
# Create bar plot for only top cities in Nigeria
plot_top <- df_reshaped_nig %>% 
  filter(City %in% c("Lagos", "Abuja", "Port Harcourt", "Kano", "Ibadan")) %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "Comparison of loreal vs nightlights approach for $12+ consumer class in Nigeria") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size = 10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

plot_top + geom_text(aes(label = paste0(round(Value/1e6, 2), "M")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 2) 

```



```{r}

# Filter for Kenya only
df_ken <- ken_nig_sa %>% 
    filter(Country == "Kenya")

# Reshape the data frame to have one value column
df_reshaped_ken <- df_ken %>% 
  pivot_longer(cols = c(loreal,nightlights,`nightlights rescaled`), names_to = "Method", values_to = "Value")

# Create bar plot
plot2 <- ggplot(df_reshaped_ken, aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "Comparison of loreal vs nightlights approach for $12+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size = 10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 12))

# Add  values on top of one bar
plot2 + 
  geom_text(aes(label = paste0(round(Value/1e6, 2), "M")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 2) 
```



```{r}
# Calculate mean square percentage error for each city
df_sa <- ken_nig_sa %>% 
    filter(Country == "South Africa")

# Create bar plot
plot_sa <- ggplot(df_sa, aes(x = reorder(City, -old_method), y = old_method, fill = "Old Method")) + 
  geom_bar(stat = "identity", position = "dodge") +
  geom_bar(aes(y = new_method, fill = "New Method"), stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "Comparison of Old vs New Method for $12+ consumer class in S.Africa",
       fill = "") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size = 10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 11))

# Add mean square percentage error
plot_sa + geom_text(aes(label = paste0(round(mspe, 2), "%")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 2)
```


```{r}
# Reshape the data frame to have one value column
df_reshaped_sa <- df_sa %>% 
  pivot_longer(cols = c(loreal,nightlights,`nightlights rescaled`), names_to = "Method", values_to = "Value")

# Create bar plot
plot3 <- ggplot(df_reshaped_sa, aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "Comparison of loreal vs nightlights approach for $12+ consumer class in S.Africa") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plot3 + 
  geom_text(aes(label = paste0(round(Value/1e6, 2), "M")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```



```{r}

# Create bar plot for only top cities in South Africa
plottop1 <- df_reshaped_sa %>% 
  filter(City %in% c("Johannesburg", "Cape Town", "Ekurhuleni", "Durban (Ethekwini)", "Pretoria")) %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "Comparison of loreal vs nightlights approach for $12+ consumer class in S.Africa") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plottop1 + 
  geom_text(aes(label = paste0(round(Value/1e6, 2), "M")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```


```{r}

## Create plot summed up by key cities for the three countries

# Reshape the data frame to have one value column
df_reshaped_all <- ken_nig_sa %>% 
  pivot_longer(cols = c(loreal,nightlights,`nightlights rescaled`), names_to = "Method", values_to = "Value") %>% 
  group_by(Country, Method) %>% 
  summarise(Value = sum(Value))


# Create bar plot
plot4 <- ggplot(df_reshaped_all, aes(x = reorder(Country, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Country", y = "$12+ Consumer class", title = "Comparison of loreal vs nighlights approach for $12+ consumer class") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plot4 + 
  geom_text(aes(label = paste0(round(Value/1e6, 2), "M")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 2)

```


## Scatter plots for comparison(Kenya, South Africa and Nigeria)

```{r}

# Create scatter plot with line of equality
plot <- ggplot(df_nig, aes(x = old_method, y = new_method, label = City)) + 
  geom_point() +
  scale_x_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  scale_y_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  labs(x = "Old Method (in thousands)", y = "New Method (in thousands)", 
       title = "Old vs New Method for $12 + in Nigeria") +
  theme_minimal()

# Add line of equality
plot + geom_abline(intercept = 0, slope = 1, color = "red") +
  geom_text(aes(label = City), size = 2, hjust = -0.1, vjust = 0.5) +
  theme(axis.title.x = element_text(size = 10), 
             axis.title.y = element_text(size = 10),
             plot.title = element_text(size = 11))




```



```{r}
#Plot old vs new method excluding abuja, port harcout and Lagos

df_nig_new <- df_nig %>% 
  filter(!City %in% c("Abuja", "Lagos", "Port Harcourt", "Kano"))


# Create scatter plot with line of equality
plot3 <- ggplot(df_nig_new, aes(x = old_method, y = new_method, label = City)) + 
  geom_point() +
  scale_x_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  scale_y_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  labs(x = "Old Method (in thousands)", y = "New Method (in thousands)", 
       title = "Old vs New Method for $12 + in Nigeria excluding large cities") +
  theme_minimal()

# Add line of equality
plot3 + geom_abline(intercept = 0, slope = 1, color = "red") +
  geom_text(aes(label = City), size = 2, hjust = -0.1, vjust = 0.5) +
  theme(axis.title.x = element_text(size = 10), 
             axis.title.y = element_text(size = 10),
             plot.title = element_text(size = 11))
```



```{r}
# Create scatter plot with line of best fit
plot1 <- ggplot(df_ken, aes(x = old_method, y = new_method, label = City)) + 
  geom_point() +
  scale_x_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  scale_y_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  labs(x = "Old Method (in thousands)", y = "New Method (in thousands)", 
       title = "Old vs New Method for $12 + in Kenya") +
  theme_minimal()

# Modify axis labels
plot1 + geom_abline(intercept = 0, slope = 1, color = "red")+
    geom_text(aes(label = City), size = 2, hjust = -0.1, vjust = 0.5) +
    theme(axis.title.x = element_text(size = 10), 
             axis.title.y = element_text(size = 10),
             plot.title = element_text(size = 11))
```

```{r}
#Scatter plot for Kenya excluding large cities

df_ken_new <- df_ken %>% 
  filter(!City %in% c("Nairobi"))

# Create scatter plot with line of best fit
plot4 <- ggplot(df_ken_new, aes(x = old_method, y = new_method, label = City)) + 
  geom_point() +
  scale_x_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  scale_y_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  labs(x = "Old Method (in thousands)", y = "New Method (in thousands)", 
       title = "Old vs New Method for $12 + in Kenya excluding large cities") +
  theme_minimal()

# Modify axis labels
plot4 + geom_abline(intercept = 0, slope = 1, color = "red")+
    geom_text(aes(label = City), size = 2, hjust = -0.1, vjust = 0.5) +
    theme(axis.title.x = element_text(size = 10), 
             axis.title.y = element_text(size = 10),
             plot.title = element_text(size = 11))

```


```{r}
# Create scatter plot with line of best fit
plot2 <- ggplot(df_sa, aes(x = old_method, y = new_method, label = City)) + 
  geom_point() +
  scale_x_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  scale_y_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  labs(x = "Old Method (in thousands)", y = "New Method (in thousands)", 
       title = "Old vs New Method for $12 + in S.Africa") +
  theme_minimal()

# Modify axis labels
plot2 + geom_abline(intercept = 0, slope = 1, color = "red") +
    geom_text(aes(label = City), size = 2, hjust = -0.1, vjust = 0.5) +
    theme(axis.title.x = element_text(size = 10), 
             axis.title.y = element_text(size = 10),
             plot.title = element_text(size = 11))
```

```{r}

## Scatter plot for South Africa excluding larger cities

df_sa_new <- df_sa %>% 
  filter(!City %in% c("Johannesburg", "Cape Town", "Ekurhuleni", "Durban (Ethekwini)", "Pretoria"))

# Create scatter plot with line of best fit
plot5 <- ggplot(df_sa_new, aes(x = old_method, y = new_method, label = City)) + 
  geom_point() +
  scale_x_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  scale_y_continuous(labels = scales::unit_format(unit = "k", scale = 1e-3))+
  labs(x = "Old Method (in thousands)", y = "New Method (in thousands)", 
       title = "Old vs New Method for $12 + in S.Africa excluding large cities") +
  theme_minimal()

# Modify axis labels
plot5 + geom_abline(intercept = 0, slope = 1, color = "red") +
    geom_text(aes(label = City), size = 2, hjust = -0.1, vjust = 0.5) +
    theme(axis.title.x = element_text(size = 10), 
             axis.title.y = element_text(size = 10),
             plot.title = element_text(size = 11))
```



```{r}

library(Metrics)

# Calculate metrics by country
country_metrics <- ken_nig_sa %>%
  group_by(Country) %>%
  summarise(
    r2 = 1 - sum((nightlights - loreal)^2) / sum((loreal - mean(loreal))^2),
    mae = mean(abs(nightlights - loreal)),
    mse = mean((nightlights - loreal)^2)
  )

# Print the country metrics table
print(country_metrics)


```

```{r}
# Calculate metrics by country
country_metrics2 <- ken_nig_sa %>%
  group_by(Country) %>%
  summarise(
    r2 = 1 - sum((nightlights - loreal)^2) / sum((loreal - mean(loreal))^2),
    rmse = sqrt(mean((nightlights - loreal)^2)),
    mape = mean(abs((nightlights - loreal) / loreal)) * 100
  )

# Print the country metrics table
print(country_metrics2)

```


```{r}
# Calculate metrics by country
country_metrics3 <- ken_nig_sa %>%
  group_by(Country) %>%
  summarise(
    r2 = 1 - sum((`nightlights rescaled` - loreal)^2) / sum((loreal - mean(loreal))^2),
    rmse = sqrt(mean((`nightlights rescaled` - loreal)^2)),
    mape = mean(abs((`nightlights rescaled` - loreal) / loreal)) * 100
  )

# Print the country metrics table
print(country_metrics3)
```



## Get distribution for residual cities

```{r}

## City spending data + residual
residual <- resid_cit %>%
    filter(ccode %in% c("NGA","ZAF", "KEN")) %>% 
    dplyr::select("year","ccode","pop","spending_data_datt", "name")



# unnest the list column

resid_df <- unnest(residual, cols = spending_data_datt)



resid_df %>% 
    View()
```


```{r}

## Create spending groups to compare with WDPro - slide 6 and 7. Please note that the code somehow includes upper bounds even though this is not included in the expression. Over 12 in this case is $12-40

country_dist <- resid_df %>%
  filter(year %in% c(2023,2030)) %>%
  group_by(ccode, year) %>%
  mutate(spending_threshold_group = ifelse(spending_threshold >= 120, "over 120",
                                            ifelse(spending_threshold >=80, "over 80",
                                               ifelse(spending_threshold >= 40, "over 40",
                                                  ifelse(spending_threshold >= 12, "over 12", "below 12"))))) %>% 
  group_by(ccode,year, spending_threshold_group) %>% 
  summarise(headcount_sum = sum(headcount),
            spending_sum =  sum(spending))

##Check totals for each year and country
country_sum <-  country_dist %>% 
    group_by(ccode, year) %>% 
    summarise(pop = sum(headcount_sum))
```



```{r}

## Get spending distribution for Kenya in 2016 to compare with survey and WDPro- slide 16

ken_dist <- resid_df %>%
  filter(year == "2016" & ccode == "KEN") %>%
  group_by(ccode, year) %>%
  mutate(spending_threshold_group = ifelse(spending_threshold >= 120, "over 120",
                                            ifelse(spending_threshold >=80, "over 80",
                                               ifelse(spending_threshold >= 40, "over 40",
                                                  ifelse(spending_threshold >= 12, "over 12", "below 12"))))) %>% 
  group_by(ccode,year, spending_threshold_group) %>% 
  summarise(headcount_sum = sum(headcount),
            spending_sum =  sum(spending))

## Check for totals
ken_sum <-  ken_dist %>% 
    group_by(ccode) %>% 
    summarise(pop = sum(headcount_sum))
```



```{r}

##To be continued
countrydist3 <- country_dist %>% 
  group_by(ccode, name, year) %>%
  summarise(over12 = sum(headcount_sum[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(headcount_sum[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(headcount_sum[spending_threshold_group %in% c("over 80", "over 120")]))

```


## Rescale NIGHTLIGHTS numbers to match WDPro

```{r}

## Nightlights + residual
olddf <- resid_cit %>%
    dplyr::select("year","ccode","pop","spending_data_datt", "name")



# unnest the list column

olddf <- unnest(olddf, cols = spending_data_datt)



olddf %>% 
    View()

```


```{r}

worlddataprodf <- worlddatapro %>% 
  group_by(ccode, year, inc_lwr, inc_upr) %>%
  summarise(sum_hc = sum(hc),
            daily_spending = sum(exp)/365) %>% 
  rename(spending_threshold = inc_upr)
    

worlddatapro %>% 
    View()

worlddataprodf %>% 
    View()


## Merge wdpro with Matts results

newdf <- merge(olddf, worlddataprodf, all = FALSE, by = c("ccode", "year", "spending_threshold"))


## Rescale numbers to match wdpro

newdf2 <- newdf %>% 
    group_by(year,ccode,spending_threshold) %>% 
    mutate(hc_new = headcount * (sum_hc/sum(headcount)),
           spending_new = (spending/365) * (daily_spending/sum(spending/365))) %>% 
    rename(hc_wdpro = sum_hc,
           hc_old = headcount)


newdf2 %>% 
    View()

##Check that totals and spending  match wdpro
check <- newdf2 %>% 
    group_by(year, ccode, spending_threshold) %>% 
    summarise(sum2 = sum(hc_new),
              tots = sum(spending_new))



##save final output

newdf2 %>% 
    saveRDS(paste0(cities,"/city_distribution_rescaled_wdpro.rds"))

```


```{r}

options(scipen = 999)
# get totals for different consumer classes to compare to old method

newdf2cons <- newdf2 %>%
  filter(ccode %in% c("KEN") & year %in% c(2022, 2030) & name %in%  c("Nairobi", "Mombasa")) %>%
  group_by(ccode, name, year) %>%
  mutate(spending_threshold_group = ifelse(spending_threshold >= 120, "over 120",
                                            ifelse(spending_threshold >=80, "over 80",
                                               ifelse(spending_threshold >= 40, "over 40",
                                                  ifelse(spending_threshold >= 12, "over 12", "below 12"))))) %>% 
  group_by(ccode,name, year, spending_threshold_group) %>% 
  summarise(headcount_sum = sum(hc_new))


TOT11 <- newdf2cons %>% 
    group_by(year, spending_threshold_group, name) %>% 
    summarise(tot = sum(headcount_sum))

TOT12 <- TOT11 %>% 
  group_by(year, name) %>%
  summarise(below12 = sum(tot[spending_threshold_group %in% c("below 12")]),
            over12 = sum(tot[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(tot[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(tot[spending_threshold_group %in% c("over 80", "over 120")]))
```


```{r}
## Get residual to match kenya survey

cons_ken <- newdf2 %>%
  filter(ccode %in% c("KEN") & year %in% c(2022, 2030) & !name %in% c("Nairobi", "Mombasa")) %>%
  group_by(ccode, name, year) %>%
  mutate(spending_threshold_group = ifelse(spending_threshold >= 120, "over 120",
                                            ifelse(spending_threshold >=80, "over 80",
                                               ifelse(spending_threshold >= 40, "over 40",
                                                  ifelse(spending_threshold >= 12, "over 12", "below 12"))))) %>% 
  group_by(ccode,name, year, spending_threshold_group) %>% 
  summarise(headcount_sum = sum(hc_new))


TOT1 <- cons_ken %>% 
    group_by(year, spending_threshold_group) %>% 
    summarise(tot = sum(headcount_sum))


TOT2 <- TOT1 %>% 
  group_by(year) %>%
  summarise(below12 = sum(tot[spending_threshold_group %in% c("below 12")]),
            over12 = sum(tot[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(tot[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(tot[spending_threshold_group %in% c("over 80", "over 120")]))
```



```{r}

newdf2cons3 <- newdf2cons %>% 
  group_by(ccode,year) %>%
  summarise(below12 = sum(headcount_sum[spending_threshold_group %in% c("below 12")]),
            over12 = sum(headcount_sum[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(headcount_sum[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(headcount_sum[spending_threshold_group %in% c("over 80", "over 120")]))


```

## Creating spending buckets using Kenyan survey data to compare to city approaches


```{r}
#Read ppp conversion factors

ppp_2017 <- read_rds("01_010_conversion_factors.rds")

#Covert local currency into 2017 ppp 

ppp_2017_ken <- ppp_2017 %>% 
    filter(ccode == "KEN")

# Get per person spending

ken_cons2 <- ken_cons %>% 
    mutate(individual_spend = tot_cons/hhsize)

ken_cons_ppp <- ken_cons2 %>% 
    mutate(tot_cons_ppp = (individual_spend/38.344658))



```



```{r}
##Create spending groups that Match WDPro

# Define spending buckets
buckets <- c(0.00, 1.00, 2.00, 2.15, 3.00, 3.65, 4.00,5.00,6.00,6.85,7.00,8.00,9.00,10.00,11.00,12.00,13.00,14.00,15.00,16.00,17.00,18.00,19.00,20.00,21.00,22.00,23.00,24.00,25.00,26.00,27.00,28.00,29.00,30.00,31.00,32.00,33.00,34.00,35.00,36.00,37.00,38.00,39.00,40.00,41.00,42.00,43.00,44.00,45.00,46.00,47.00,48.00,49.00,50.00,51.00,52.00,53.00,54.00,55.00,56.00,57.00,58.00,59.00,60.00,61.00,62.00,63.00,64.00,65.00,66.00,67.00,68.00,69.00,70.00,71.00,72.00,73.00,74.00,75.00,76.00,77.00,78.00,79.00,80.00,81.00,82.00,83.00,84.00,85.00,86.00,87.00,88.00,89.00,90.00,91.00,92.00,93.00,94.00,95.00,96.00,97.00,98.00,99.00,100.00,101.00,102.00,103.00,104.00,105.00,106.00,107.00,108.00,109.00,110.00,111.00,112.00,113.00,114.00,115.00,116.00,117.00,118.00,119.00,120.00,121.00,122.00,123.00,124.00,125.00,126.00,127.00,128.00,129.00,130.00,131.00,132.00, 133.00,134.00,135.00,136.00,137.00,138.00,139.00,140.00,141.00,142.00,143.00,144.00,145.00,146.00,147.00,148.00,149.00,150.00, 151.00,152.00,153.00,154.00,155.00,156.00,157.00,158.00,159.00,160.00,999.00)  

# Create empty result dataframe
df <- data.frame(
  inc_lwr = numeric(0),
  inc_upr = numeric(0),
  total_weighted_pop = numeric(0),
  total_spending = numeric(0),
  stringsAsFactors = FALSE
)

# Iterate over the spending buckets
for (i in 1:(length(buckets) - 1)) {
  lower_limit <- buckets[i]
  upper_limit <- buckets[i+1]
  
  # Filter the dataframe for the current spending bucket
  df2 <- ken_cons_ppp[ken_cons_ppp$tot_cons_ppp >= lower_limit & ken_cons_ppp$tot_cons_ppp < upper_limit, ]
  
  # Calculate total weighted population and total spending for the current bucket
  total_weighted_pop <- sum(df2$weight_pop)
  total_spending <- sum(df2$tot_cons_ppp)
  
  # Add the results to the result dataframe
  df <- rbind(df, data.frame(inc_lwr = lower_limit, inc_hgr = upper_limit, total_weighted_pop, total_spending))
}
```





```{r}
## Get consumer class distribution from survey for 2016

survey_df <- df %>%
  mutate(spending_threshold_group = ifelse(inc_hgr >= 120, "over 120",
                                            ifelse(inc_hgr >=80, "over 80",
                                               ifelse(inc_hgr >= 40, "over 40",
                                                  ifelse(inc_hgr >= 12, "over 12", "below 12"))))) %>% 
  group_by(spending_threshold_group) %>% 
  summarise(headcount_sum = sum(total_weighted_pop),
            tot_spend = sum(total_spending))
```



```{r}
survey_df2 <- df %>%
  mutate(spending_threshold_group = ifelse(inc_hgr >= 120 , "over 120",
                                            ifelse(inc_hgr >=80 & inc_hgr < 120, "over 80",
                                               ifelse(inc_hgr >= 40 & inc_hgr < 80, "over 40",
                                                  ifelse(inc_hgr >= 12 & inc_hgr < 40, "over 12", "below 12"))))) %>% 
  group_by(spending_threshold_group) %>% 
  summarise(headcount_sum = sum(total_weighted_pop),
            tot_spend = sum(total_spending))
```

```{r}
survey_tot <- survey_df %>% 
  summarise(pop = sum(headcount_sum),
            spend = sum(tot_spend))
```

```{r}
## Create spending buckets by county

# Define spending buckets
buckets <- c(0.00, 1.00, 2.00, 2.15, 3.00, 3.65, 4.00,5.00,6.00,6.85,7.00,8.00,9.00,10.00,11.00,12.00,13.00,14.00,15.00,16.00,17.00,18.00,19.00,20.00,21.00,22.00,23.00,24.00,25.00,26.00,27.00,28.00,29.00,30.00,31.00,32.00,33.00,34.00,35.00,36.00,37.00,38.00,39.00,40.00,41.00,42.00,43.00,44.00,45.00,46.00,47.00,48.00,49.00,50.00,51.00,52.00,53.00,54.00,55.00,56.00,57.00,58.00,59.00,60.00,61.00,62.00,63.00,64.00,65.00,66.00,67.00,68.00,69.00,70.00,71.00,72.00,73.00,74.00,75.00,76.00,77.00,78.00,79.00,80.00,81.00,82.00,83.00,84.00,85.00,86.00,87.00,88.00,89.00,90.00,91.00,92.00,93.00,94.00,95.00,96.00,97.00,98.00,99.00,100.00,101.00,102.00,103.00,104.00,105.00,106.00,107.00,108.00,109.00,110.00,111.00,112.00,113.00,114.00,115.00,116.00,117.00,118.00,119.00,120.00,121.00,122.00,123.00,124.00,125.00,126.00,127.00,128.00,129.00,130.00,131.00,132.00, 133.00,134.00,135.00,136.00,137.00,138.00,139.00,140.00,141.00,142.00,143.00,144.00,145.00,146.00,147.00,148.00,149.00,150.00, 151.00,152.00,153.00,154.00,155.00,156.00,157.00,158.00,159.00,160.00,999.00)

# Create empty result dataframe
df_county <- data.frame(
  county = character(0),
  inc_lwr = numeric(0),
  inc_upr = numeric(0),
  total_weighted_pop = numeric(0),
  total_spending = numeric(0),
  stringsAsFactors = FALSE
)

# Iterate over the counties
for (county in unique(ken_cons_ppp$county)) {
  # Filter the dataframe for the current county
     county_data <- ken_cons_ppp[ken_cons_ppp$county == county, ]
    
    # Iterate over the spending buckets
    for (i in 1:(length(buckets) - 1)) {
      lower_limit <- buckets[i]
      upper_limit <- buckets[i+1]
      
      # Filter the county data for the current spending bucket
      filtered_data <- county_data[county_data$tot_cons_ppp >= lower_limit & county_data$tot_cons_ppp < upper_limit, ]
      
      # Calculate total weighted population and total spending for the current bucket
      total_weighted_pop <- sum(filtered_data$weight_pop)
      total_spending <- sum(filtered_data$tot_cons_ppp)
      
      # Add the results to the result dataframe
      df_county <- rbind(df_county, data.frame(county, inc_lwr = lower_limit, inc_upr = upper_limit, total_weighted_pop, total_spending))
    }
  }





```



## Rescale survey data to match WDPro


```{r}
##Start by merging wdpro with kenya survey data

## Filter Ken and 2022 from world data pro

wdpro_ken <- worlddataprodf %>% 
    filter(ccode == "KEN" & year == "2022") %>% 
    rename(inc_upr = spending_threshold)

##Confirm totals

wdpro_check <- wdpro_ken %>% 
    group_by(ccode) %>% 
    summarise(sum = sum(sum_hc))

#Trim whitespaces to enable merging

df_county$inc_lwr <- trimws(df_county$inc_lwr)
df_county$inc_upr <- trimws(df_county$inc_upr)
wdpro_ken$inc_lwr <- trimws(wdpro_ken$inc_lwr)
wdpro_ken$inc_upr <- trimws(wdpro_ken$inc_upr)

#Convert to numeric

df_county$inc_lwr <- as.numeric(df_county$inc_lwr)
df_county$inc_upr <- as.numeric(df_county$inc_upr)
wdpro_ken$inc_lwr <- as.numeric(wdpro_ken$inc_lwr)
wdpro_ken$inc_upr <- as.numeric(wdpro_ken$inc_upr)

#Merge wdpro with kenya survey data

ken_merge <- merge(df_county, wdpro_ken, all = FALSE , by = c("inc_lwr", "inc_upr"))


##Create new column with rescaled values

ken_rescaled <- ken_merge %>% 
    group_by(inc_lwr,inc_upr) %>% 
    mutate(pop = total_weighted_pop * (sum_hc/sum(total_weighted_pop)),
           tot_spend = total_spending *(daily_spending/sum(total_spending)))

ken_rescaled %>% 
    View()

##Check to see if it matches WDPro
ken_check <- ken_rescaled %>% 
    group_by(ccode, inc_lwr,inc_upr) %>% 
    summarise(sum = sum(pop),
              tot = sum(tot_spend))

```






```{r}

ken_rescaled_agg <- ken_rescaled %>%
  filter(county %in% c("Eldoret","Kisumu", "Nairobi","Nakuru", "Mombasa")) %>%
  group_by(county,inc_lwr,inc_upr) %>%
  mutate(spending_threshold_group = ifelse(inc_upr >= 120, "over 120",
                                            ifelse(inc_upr >=80, "over 80",
                                               ifelse(inc_upr >= 40, "over 40",
                                                  ifelse(inc_upr >= 12, "over 12", "below 12"))))) %>% 
  group_by(county,spending_threshold_group) %>% 
  summarise(headcount_sum = sum(pop),
            actual = sum(total_weighted_pop))
```


```{r}
ken_res_agg <- ken_rescaled %>%
  filter(!county %in% c("Nairobi" ,"Mombasa")) %>%
  group_by(county,inc_lwr,inc_upr) %>%
  mutate(spending_threshold_group = ifelse(inc_upr >= 120, "over 120",
                                            ifelse(inc_upr >=80, "over 80",
                                               ifelse(inc_upr >= 40, "over 40",
                                                  ifelse(inc_upr >= 12, "over 12", "below 12"))))) %>% 
  group_by(county,spending_threshold_group) %>% 
  summarise(headcount_sum = sum(pop),
            actual = sum(total_weighted_pop))
```



```{r}
kenagg2 <- ken_rescaled_agg %>% 
  group_by(county) %>%
  summarise(over12 = sum(headcount_sum[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(headcount_sum[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(headcount_sum[spending_threshold_group %in% c("over 80", "over 120")]))
```


```{r}
kencountagg <- ken_res_agg %>% 
  summarise(over12 = sum(headcount_sum[spending_threshold_group %in% c("over 12", "over 40", "over 80", "over 120")]),
            over40 = sum(headcount_sum[spending_threshold_group %in% c("over 40", "over 80", "over 120")]),
            over80 = sum(headcount_sum[spending_threshold_group %in% c("over 80", "over 120")]))

ken_sum <- kencountagg %>% 
    summarise(over12 = sum(over12),
              over40 = sum(over40),
              over80 = sum(over80))
```


## Comparison with survey data

```{r}


library(readxl)
kenya_cities <- read_xlsx("kenya_cities.xlsx")

# Reshape the data frame to have one value column
kenya_cities<- kenya_cities %>% 
  pivot_longer(cols = c(loreal,nightlights,`nightlights rescaled`, survey), names_to = "Method", values_to = "Value")

# Create bar plot
plot12 <- kenya_cities %>% 
  filter(spending_group == "12USD" & City %in% c("Nairobi", "Mombasa")) %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "$12+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plot12 + 
  geom_text(aes(label = paste0(round(Value/1e3, 2), "Thsd")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```

```{r}
# Create bar plot
plot40 <- kenya_cities %>% 
  filter(spending_group == "40USD" & City %in% c("Nairobi", "Mombasa")) %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$40+ Consumer class", title = "$40+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plot40 + 
  geom_text(aes(label = paste0(round(Value/1e3, 2), "Thsd")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```


```{r}
# Create bar plot
plot80 <- kenya_cities %>% 
  filter(spending_group == "80USD"  & City %in% c("Nairobi", "Mombasa")) %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$80+ Consumer class", title = "$80+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plot80 + 
  geom_text(aes(label = paste0(round(Value/1e3, 2), "Thsd")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```







## Plot with residual i.e compare nightlights rescaled to survey


```{r}
kenya_res <- read_xlsx("kenya_cities_res.xlsx")

# Reshape the data frame to have one value column
kenya_res<- kenya_res %>% 
  pivot_longer(cols = c(`nightlights rescaled`, survey), names_to = "Method", values_to = "Value")

# Create bar plot
plotres1 <- kenya_res %>% 
  filter(spending_group == "12USD") %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$12+ Consumer class", title = "$12+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plotres1 + 
  geom_text(aes(label = paste0(round(Value/1e3, 2), "Thsd")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```



```{r}
# Create bar plot
plotres2 <- kenya_res %>% 
  filter(spending_group == "40USD") %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$40+ Consumer class", title = "$40+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plotres2 + 
  geom_text(aes(label = paste0(round(Value/1e3, 2), "Thsd")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```


```{r}
# Create bar plot
plotres3 <- kenya_res %>% 
  filter(spending_group == "80USD") %>% 
  ggplot(aes(x = reorder(City, -Value), y = Value, fill = Method)) + 
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "City", y = "$80+ Consumer class", title = "$80+ consumer class in Kenya") +
  theme_minimal() +
  coord_flip() +
  theme(axis.title.x = element_text(size =  10), 
        axis.title.y = element_text(size = 10),
        plot.title = element_text(size = 10))

#Add value on top of  bars

plotres3 + 
  geom_text(aes(label = paste0(round(Value/1e3, 2), "Thsd")), 
                 position = position_dodge(width = 0.9), vjust = -0.5, size = 1.5)
```


