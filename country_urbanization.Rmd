---
title: "country_urbanization"
output: html_document
date: "2023-04-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Load libraries

library(tidyverse)
library(here)
library(viridis)
library(sf)
library(ggpp)
library(raster)
library(rasterVis)
library(readxl)
library(xml2)
library("RColorBrewer")
library(foreign)
library(haven)
library(Hmisc)
```


```{r}
## Read kenya population density data

path <- "G:\\Shared drives\\DATA_WDL\\Mpro_2.0\\01_Data\\R_2022_12_29\\2023_01_23_2017ppp\\01_inputs\\population\\World pop\\Kenya"

ken <-  raster(paste0(path, "\\ken_pd_2020_1km_UNadj.tif"))

##Read Kenya consumption survey data

ken_cons <- read_dta("ken_consumption\\Consumption_aggregate.dta")

## Read shape file


shape_kenya <- read_sf(here::here("ken_shape/gadm41_KEN_1.shp"))


```

## Aggregate consumption kenya

```{r}
unique(ken_cons$county)
```


```{r}

#Convert column county and resid to factor columns
ken_cons$county <- as_factor(ken_cons$county)
ken_cons$resid <- as_factor(ken_cons$resid)
ken_cons$eatype <- as_factor(ken_cons$eatype)
```



```{r}
#Get the total consumption

ken_cons <- ken_cons %>%
    mutate(tot_cons = rowSums(dplyr::select(., padqnfitems:padqfdcons)))


```

```{r}
# Add quantiles from national distribution

# Select relevant variables from survey data

ken_var <- ken_cons %>% 
    dplyr::select(county, resid,weight_pop,tot_cons)

# Compute quantiles

ken_qnt <- wtd.quantile(ken_var$tot_cons, weights = ken_var$weight_pop, probs = seq(0, 1, 0.1))

# create data frame with quantiles and corresponding cons values
ken_qnt <- data.frame(cbind(names(ken_qnt), ken_qnt))
names(ken_qnt) <- c("quantile", "value")
ken_qnt$value <- as.numeric(ken_qnt$value)



# match data with quantiles
ken_var$quantile <- ken_qnt$quantile[findInterval(ken_var$tot_cons, ken_qnt$value, rightmost.closed = TRUE)+1]

ken_var %>% 
    View()
```

```{r}
# compute shares of groups per quantile
ken_var2 <- ken_var %>%
  group_by(resid) %>%
  mutate(wgt_qtl = sum(weight_pop)) %>% 
  group_by(quantile, resid) %>%
  summarise(share = sum(weight_pop)/wgt_qtl) %>%
  distinct()

#

```


## World bank urbanization classification
```{r}
# Extract population values

library(exactextractr)

shape_kenya$pop_2020 <- exact_extract(ken, shape_kenya, "sum")

```



```{r}
# Convert county area to square kilometers
shape_kenya$area_km2 <- st_area(shape_kenya) / 1e+06
```


```{r}
# Calculate population density for each county in square kilometers
shape_kenya$pop_density_km2 <- shape_kenya$pop_2020 / shape_kenya$area_km2
```

```{r}
# Remove [1/m^2] from pop_density_km2
shape_kenya$pop_density_km2 <- gsub("\\s*\\[1/m\\^2\\]", "", shape_kenya$pop_density_km2)
shape_kenya$pop_density_km2 <- as.numeric(shape_kenya$pop_density_km2)
```




```{r}
# Create new column for city/town/rural classification
shape_kenya$urbanization <- ifelse(shape_kenya$pop_2020 > 50000 & shape_kenya$pop_density_km2 > 1500, "City", 
                                      ifelse(shape_kenya$pop_2020 > 5000 & shape_kenya$pop_density_km2 > 250, "Town", "Rural"))

```

```{r}
# Find the maximum population and maximum population density in the data frame
max_pop <- max(shape_kenya$pop_2020)
max_density <- max(shape_kenya$pop_density_km2)

# Create a new column for urban proportion
shape_kenya$urban_proportion <- 0

# Calculate urban proportion for counties with population density greater than 1500 and population greater than 50000
pop_density_condition <- shape_kenya$pop_density_km2 > 1500 & shape_kenya$pop_2020 >= 50000

shape_kenya$urban_proportion[pop_density_condition] <- ((shape_kenya$pop_density_km2[pop_density_condition] / max_density) * 0.5 + (shape_kenya$pop_2020[pop_density_condition] / max_pop) * 0.5) * 100

# Calculate urban proportion for counties with population density greater than 250 and population less than or equal to 5000
pop_condition <- shape_kenya$pop_2020 <= 50000 & shape_kenya$pop_2020 >= 5000 & shape_kenya$pop_density_km2 > 250
shape_kenya$urban_proportion[pop_condition] <- ((shape_kenya$pop_density_km2[pop_condition] / max_density) * 0.3 + (shape_kenya$pop_2020[pop_condition] / max_pop) * 0.7) * 100

# Calculate urban proportion for counties with population density less than or equal to 250
density_condition <- shape_kenya$pop_density_km2 <= 250
shape_kenya$urban_proportion[density_condition] <- shape_kenya$pop_2020[density_condition] / max_pop * 100

# Set urban proportion to 0 for counties not meeting any of the conditions
shape_kenya$urban_proportion[!(pop_density_condition | pop_condition | density_condition)] <- 0

```

```{r}
# Set the maximum population and population density in the data frame
max_pop <- max(shape_kenya$pop_2020)
max_density <- max(shape_kenya$pop_density_km2)

#calculate the urbanization rate for each county

shape_kenya$urbanization <- ifelse(shape_kenya$pop_density_km2 > 1500 & shape_kenya$pop_2020 >= 50000,(0.6 * (shape_kenya$pop_density_km2 / max_density) + 0.4 * (shape_kenya$pop_2020 / max_pop)) * 100,
                            ifelse(shape_kenya$pop_density_km2 > 250 & shape_kenya$pop_2020 >= 5000,
                                            (0.2 * (shape_kenya$pop_density_km2 / max_density) + 0.8 * (shape_kenya$pop_2020 / max_pop)) * 100,
                            ifelse(shape_kenya$pop_density_km2 > 0 & shape_kenya$pop_density_km2 <= 250 & shape_kenya$pop_2020 > 0 & shape_kenya$pop_2020 < 5000, (0.1 * (shape_kenya$pop_density_km2 / max_density) + 0.9 * (shape_kenya$pop_2020 / max_pop)) * 100, (shape_kenya$pop_density_km2 / max_density) * 7 + (shape_kenya$pop_2020 / max_pop) * 3
                                        )
                                    )
                                )

```

